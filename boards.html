<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalleyeFest - Leaderboards</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .navigation {
            background: #004080;
            padding: 15px 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        h1 {
            color: #004080;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .apply-filter {
            background-color: #004080;
            color: white;
        }
        
        .reset-filter {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .apply-filter:hover {
            background-color: #00305f;
        }
        
        .reset-filter:hover {
            background-color: #e0e0e0;
        }
        
        .leaderboards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .leaderboard {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .leaderboard:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .leaderboard-header {
            background: #004080;
            color: white;
            padding: 15px;
            position: relative;
        }
        
        .leaderboard-title {
            margin: 0;
            font-size: 1.2em;
        }
        
        .leaderboard-species {
            font-style: italic;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .leaderboard-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff6b00;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .leaderboard-body {
            padding: 15px;
        }
        
        .leaderboard-detail {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .detail-label {
            font-weight: bold;
            width: 100px;
            color: #666;
        }
        
        .leaderboard-location {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .leaderboard-action {
            padding: 10px 15px;
            text-align: right;
            border-top: 1px solid #eee;
        }
        
        .view-button {
            background: #004080;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .view-button:hover {
            background-color: #00305f;
        }
        
        .derby-section {
            margin-bottom: 30px;
        }
        
        .derby-title {
            color: #004080;
            font-size: 1.5em;
            margin: 0 0 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        
        .derby-title:hover {
            background-color: #f8f9fa;
        }
        
        .derby-title::after {
            content: 'â–¼';
            font-size: 0.8em;
            transition: transform 0.3s;
        }
        
        .derby-title.collapsed::after {
            transform: rotate(-90deg);
        }
        
        .derby-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        
        .derby-content.collapsed {
            max-height: 0;
        }
        
        .derby-content.expanded {
            max-height: 2000px;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }
            
            .derby-content {
                grid-template-columns: 1fr;
            }
        }
        
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #666;
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="index.html" class="nav-link">Home</a>
        <a href="event.html" class="nav-link">Events</a>
        <a href="post.html" class="nav-link">Posts</a>
        <a href="sponsor.html" class="nav-link">Sponsors</a>
        <a href="boards.html" class="nav-link active">Leaderboards</a>
    </div>
    
    <div class="container">
        <h1>Fishing Leaderboards</h1>
        
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filter-species">Fish Species</label>
                    <select id="filter-species">
                        <option value="">All Species</option>
                        <!-- Species options will be populated dynamically -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-derby">Derby</label>
                    <select id="filter-derby">
                        <option value="">All Derbies</option>
                        <!-- Derby options will be populated dynamically -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-sort">Sort By</label>
                    <select id="filter-sort">
                        <option value="recent">Most Recent</option>
                        <option value="name">Name</option>
                        <option value="species">Species</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-buttons">
                <button class="reset-filter" id="reset-filters">Reset Filters</button>
                <button class="apply-filter" id="apply-filters">Apply Filters</button>
            </div>
        </div>
        
        <div id="leaderboards-container">
            <!-- Leaderboards will be inserted here -->
        </div>
    </div>
    
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://tdecpfvclvqcqjfyxgnn.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkZWNwZnZjbHZxY3FqZnl4Z25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NTkyNTgsImV4cCI6MjA1ODIzNTI1OH0.EkTjt4HtcQN5qX--PBBPgB8dO49mfIjpJHp_vkFV0-U'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        // Filters state
        let filters = {
            species: '',
            derby: '',
            sort: 'recent'
        }
        
        // Fetch and display rankboards
        async function fetchRankboards() {
            try {
                console.log('Fetching rankboards...')
                const { data, error } = await supabase
                    .from('rankboard')
                    .select('*, media:logo_media_id(*), derby:derby_id(*, product:product_id(*)), product:product_id(*)')
                    .order('created_at', { ascending: false })
                
                if (error) throw error
                
                console.log('Rankboards:', data)
                
                // Populate species dropdown with unique values
                const speciesSet = new Set()
                data.forEach(rankboard => {
                    if (rankboard.species) {
                        speciesSet.add(rankboard.species)
                    }
                })
                
                const speciesDropdown = document.getElementById('filter-species')
                speciesDropdown.innerHTML = '<option value="">All Species</option>'
                speciesSet.forEach(species => {
                    const option = document.createElement('option')
                    option.value = species
                    option.textContent = species
                    speciesDropdown.appendChild(option)
                })
                
                // Populate derby dropdown with unique values
                const derbySet = new Set()
                const derbyMap = new Map()
                data.forEach(rankboard => {
                    if (rankboard.derby && rankboard.derby.id) {
                        derbySet.add(rankboard.derby.id)
                        derbyMap.set(rankboard.derby.id, rankboard.derby.name || 'Derby Event')
                    }
                })
                
                const derbyDropdown = document.getElementById('filter-derby')
                derbyDropdown.innerHTML = '<option value="">All Derbies</option>'
                derbySet.forEach(derbyId => {
                    const option = document.createElement('option')
                    option.value = derbyId
                    option.textContent = derbyMap.get(derbyId)
                    derbyDropdown.appendChild(option)
                })
                
                // Apply filters
                let filteredData = data
                
                if (filters.species) {
                    filteredData = filteredData.filter(rankboard => rankboard.species === filters.species)
                }
                
                if (filters.derby) {
                    filteredData = filteredData.filter(rankboard => rankboard.derby && rankboard.derby.id === filters.derby)
                }
                
                // Apply sorting
                switch (filters.sort) {
                    case 'name':
                        filteredData.sort((a, b) => {
                            const nameA = a.metadata?.name || ''
                            const nameB = b.metadata?.name || ''
                            return nameA.localeCompare(nameB)
                        })
                        break
                    case 'species':
                        filteredData.sort((a, b) => {
                            const speciesA = a.species || ''
                            const speciesB = b.species || ''
                            return speciesA.localeCompare(speciesB)
                        })
                        break
                    default: // 'recent' - already sorted by created_at desc
                        break
                }
                
                displayRankboards(filteredData)
            } catch (error) {
                console.error('Error fetching rankboards:', error.message)
            }
        }
        
        // Display rankboards
        function displayRankboards(rankboards) {
            const leaderboardsContainer = document.getElementById('leaderboards-container')
            leaderboardsContainer.innerHTML = '' // Clear existing leaderboards
            
            // Group rankboards by derby_id
            const groupedByDerby = {}
            
            rankboards.forEach(rankboard => {
                const derbyId = rankboard.derby_id || 'no_derby'
                if (!groupedByDerby[derbyId]) {
                    groupedByDerby[derbyId] = []
                }
                groupedByDerby[derbyId].push(rankboard)
            })
            
            // If no results after filtering
            if (Object.keys(groupedByDerby).length === 0) {
                const noResults = document.createElement('div')
                noResults.className = 'no-results'
                noResults.textContent = 'No leaderboards match your filter criteria.'
                leaderboardsContainer.appendChild(noResults)
                return
            }
            
            // Process each derby group
            Object.entries(groupedByDerby).forEach(([derbyId, derbysRankboards]) => {
                // Sort rankboards within each derby by metadata.number if it exists
                derbysRankboards.sort((a, b) => {
                    const numA = a.metadata?.number || 0
                    const numB = b.metadata?.number || 0
                    return numA - numB
                })
                
                // Create a derby section
                const derbySectionElement = document.createElement('div')
                derbySectionElement.className = 'derby-section'
                
                // Derby title
                const titleElement = document.createElement('h2')
                titleElement.className = 'derby-title'
                
                if (derbyId !== 'no_derby') {
                    titleElement.textContent = derbysRankboards[0].derby?.name || 'Derby Event'
                } else {
                    titleElement.textContent = 'Other Leaderboards'
                }
                
                // Create the content container
                const contentElement = document.createElement('div')
                contentElement.className = 'derby-content expanded'
                
                // Add click handler for collapsing/expanding
                titleElement.addEventListener('click', () => {
                    titleElement.classList.toggle('collapsed')
                    contentElement.classList.toggle('collapsed')
                    contentElement.classList.toggle('expanded')
                })
                
                // Add rankboards to the content container
                derbysRankboards.forEach(rankboard => {
                    if (!rankboard.metadata?.name) {
                        return // Skip rankboards without a name
                    }
                    
                    const leaderboardElement = document.createElement('div')
                    leaderboardElement.className = 'leaderboard'
                    
                    // Get the image URL if media exists
                    let logoUrl = ''
                    if (rankboard.media) {
                        const logoData = supabase.storage.from(rankboard.media.bucket).getPublicUrl(rankboard.media.file_path)
                        logoUrl = logoData.data.publicUrl
                    }
                    
                    // Add number to title if it exists
                    const numberPrefix = rankboard.metadata.number ? `${rankboard.metadata.number}. ` : ''
                    
                    leaderboardElement.innerHTML = `
                        <div class="leaderboard-header">
                            <h3 class="leaderboard-title">${numberPrefix}${rankboard.metadata.name}</h3>
                            <div class="leaderboard-species">${rankboard.species}</div>
                            ${rankboard.is_main ? '<span class="leaderboard-badge">Main</span>' : ''}
                        </div>
                        <div class="leaderboard-body">
                            <div class="leaderboard-detail">
                                <span class="detail-label">Type:</span>
                                <span>${rankboard.type_ || 'Standard'}</span>
                            </div>
                            <div class="leaderboard-detail">
                                <span class="detail-label">Sort by:</span>
                                <span>${rankboard.sorter_type || 'Default'}</span>
                            </div>
                            <div class="leaderboard-location">
                                Location: ${rankboard.center_lat.toFixed(4)}, ${rankboard.center_long.toFixed(4)} 
                                (${rankboard.radius} mi radius)
                            </div>
                        </div>
                        <div class="leaderboard-action">
                            <a href="leaderboard-detail.html?id=${rankboard.id}" class="view-button">View Rankings</a>
                        </div>
                    `
                    
                    contentElement.appendChild(leaderboardElement)
                })
                
                // Assemble the derby section
                derbySectionElement.appendChild(titleElement)
                derbySectionElement.appendChild(contentElement)
                leaderboardsContainer.appendChild(derbySectionElement)
            })
        }
        
        // Event listeners for filters
        document.getElementById('apply-filters').addEventListener('click', () => {
            filters.species = document.getElementById('filter-species').value
            filters.derby = document.getElementById('filter-derby').value
            filters.sort = document.getElementById('filter-sort').value
            fetchRankboards()
        })
        
        document.getElementById('reset-filters').addEventListener('click', () => {
            document.getElementById('filter-species').value = ''
            document.getElementById('filter-derby').value = ''
            document.getElementById('filter-sort').value = 'recent'
            
            filters = {
                species: '',
                derby: '',
                sort: 'recent'
            }
            
            fetchRankboards()
        })
        
        // Fetch data when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchRankboards()
        })
    </script>
</body>
</html> 